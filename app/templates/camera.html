<!DOCTYPE html>
<html>
  <head>
    <title>WebRover1 Camera</title>
  </head>
  <body>
    <video id="video" width="400" height="300" autoplay></video>
    <canvas id="canvas" width="400" height="300">
    <!--div id="camera" style="width: 400px; height: 300px; max-height: 100%;">
      <div class="placeholder">
        Your browser does not support camera access.
      </div>
    </div><br-->

    <script src="/static/jquery.min.js"></script>
    <script type="text/javascript" src="/static/socket.io-1.4.5.js"></script>
    <script type="text/javascript" src="/static/canvas-to-blob.min.js"></script>
    <script>
      var socket, peerConnection, dataChannel;
      window.addEventListener("DOMContentLoaded", function() {
        // Grab elements, create settings, etc.
        var canvas = document.getElementById("canvas"),
            context = canvas.getContext("2d"),
            video = document.getElementById("video"),
            videoObj = { "video": true },
            errBack = function(error) {
                console.log("Video capture error: ", error.code); 
            };

        if(navigator.getUserMedia) { // Standard
            navigator.getUserMedia(videoObj, function(stream) {
                video.src = stream;
            }, errBack);
        } else if(navigator.webkitGetUserMedia) { // WebKit-prefixed
            navigator.webkitGetUserMedia(videoObj, function(stream){
                video.src = window.URL.createObjectURL(stream);
            }, errBack);
        } else if(navigator.mozGetUserMedia) { // moz-prefixed
            navigator.mozGetUserMedia(videoObj, function(stream){
                video.src = window.URL.createObjectURL(stream);
            }, errBack);
        }
        video.play();

        function capture(done) {
            context.drawImage(video, 0, 0, 400, 300);
            //canvas.toBlob(done, "image/jpeg", 0.85);
            done(canvas.toDataURL("image/jpeg", 0.85));
        };

        function upload(data, done) {
            $.ajax({
              type: "POST",
              url: "/upload/",
              data: data,
              contentType: "image/jpeg",
              processData: false
            }).done(done);
        };

        var snapshots = [];
        var delay = 0;
        var uploading = null;
        function uploaded(response) {
          delay = parseInt(response)
          uploading = null;
        };
        /*setInterval(function() {
          var timestamp = Date.now();
          function process(snapshot) {
            var length = snapshots.push({ts: timestamp, img: snapshot});

            var index = -1;
            for (var i = 0; i < length; i++) {
              if (snapshots[i].ts > timestamp - delay) {
                break;
              }
              index = i;
            }
            if (index >= 0)
            {
              // avoid flooding the server
              if (uploading == null || Date.now() > uploading + 5000) {
                uploading = Date.now();
                upload(snapshots[index].img, uploaded);
              }
              snapshots.splice(0, index + 1);
            }
          };
          capture(process);
        }, 500); */

        socket = io.connect('wss://legorover.space', {transports: ['websocket']});

        var config = {"iceServers": []}; //"iceServers": [{'url': 'stun:legorover.space:3478'}]};
        var connection = {'optional': [{'DtlsSrtpKeyAgreement': true}, {'RtpDataChannels': true}]};
        peerConnection = new webkitRTCPeerConnection(config, connection);
        peerConnection.onicecandidate = function(e) {
            if (!peerConnection || !e || !e.candidate) return;
            socket.emit('offer ice', e.candidate); //JSON.stringify(e.candidate));
            console.log('offer ice');
            console.log(e.candidate);
        }

        dataChannel = peerConnection.createDataChannel('camera', {reliable: false});
        dataChannel.onmessage = function(e){console.log("DC message:" +e.data);};
        dataChannel.onopen = function(){console.log("------ DATACHANNEL OPENED ------"); dataChannel.send('hello!');}
        dataChannel.onclose = function(){
          console.log("------- DC closed! -------");
        };
        dataChannel.onerror = function(){console.log("DC ERROR!!!");};

        socket.on('connect', function() {
          var sdpConstraints = {'mandatory': {'OfferToReceiveAudio': false, 'OfferToReceiveVideo': false}};
          peerConnection.createOffer(function (sdp) {
            peerConnection.setLocalDescription(sdp);
            socket.emit('offer', sdp);
            console.log("------ SEND OFFER ------");
          }, function (err) {
            console.log('offer error ' + err);
          }, sdpConstraints);
        });

        socket.on('answer ice', function (iceCandidate) {
          console.log('answer ice');
          console.log(iceCandidate);
          //var iceCandidate = JSON.parse(data);
          peerConnection.addIceCandidate(new RTCIceCandidate(iceCandidate));
        });
        socket.on('answer', function processAnswer(answer) {
          peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
          console.log("------ PROCESSED ANSWER ------");
          // seems to stop here, never receives answer ice, then datachannel.onclose called
        });



      }, false);
    </script>
  </body>
</html>